import { z } from "zod";

// Legal interpretation search tool - Search for statutory interpretations
export const searchInterpretationsSchema = z.object({
  query: z.string().describe("Search keyword (e.g., 'ìë™ì°¨', 'ê·¼ë¡œê¸°ì¤€ë²•')"),
  display: z.number().min(1).max(100).default(20).describe("Results per page (default: 20, max: 100)"),
  page: z.number().min(1).default(1).describe("Page number (default: 1)"),
  sort: z.enum(["lasc", "ldes", "dasc", "ddes", "nasc", "ndes"]).optional()
    .describe("Sort option: lasc/ldes (case name), dasc/ddes (date), nasc/ndes (interpretation number)"),
});

export type SearchInterpretationsInput = z.infer<typeof searchInterpretationsSchema>;

export async function searchInterpretations(args: SearchInterpretationsInput): Promise<string> {
  const apiKey = process.env.LAW_OC;
  if (!apiKey) {
    throw new Error("LAW_OC environment variable not set");
  }

  const params = new URLSearchParams({
    OC: apiKey,
    target: "expc",
    type: "XML",
    query: args.query,
    display: args.display.toString(),
    page: args.page.toString(),
  });

  if (args.sort) params.append("sort", args.sort);

  const url = `https://www.law.go.kr/DRF/lawSearch.do?${params.toString()}`;
  const response = await fetch(url);

  if (!response.ok) {
    throw new Error(`API error: ${response.status}`);
  }

  const xmlText = await response.text();

  // Simple XML parsing
  const result = parseXML(xmlText);

  if (!result.LawSearch) {
    throw new Error("Invalid response format from API");
  }

  const data = result.LawSearch;
  const totalCount = parseInt(data.totalCnt || "0");
  const currentPage = parseInt(data.page || "1");
  const expcs = data.expc ? (Array.isArray(data.expc) ? data.expc : [data.expc]) : [];

  if (totalCount === 0) {
    return "No legal interpretations found for the given query.";
  }

  let output = `Found ${totalCount} legal interpretation(s) (Page ${currentPage}):\n\n`;

  for (const expc of expcs) {
    output += `[${expc.ë²•ë ¹í•´ì„ë¡€ì¼ë ¨ë²ˆí˜¸}] ${expc.ì•ˆê±´ëª…}\n`;
    output += `  Interpretation Number: ${expc.ë²•ë ¹í•´ì„ë¡€ë²ˆí˜¸ || "N/A"}\n`;
    output += `  Response Date: ${expc.íšŒì‹ ì¼ì || "N/A"}\n`;
    output += `  Interpreting Agency: ${expc.í•´ì„ê¸°ê´€ëª… || "N/A"}\n`;
    if (expc.ë²•ë ¹í•´ì„ë¡€ìƒì„¸ë§í¬) {
      output += `  Link: ${expc.ë²•ë ¹í•´ì„ë¡€ìƒì„¸ë§í¬}\n`;
    }
    output += `\n`;
  }

  output += `\nTo retrieve full text, use get_interpretation_text with the ID (ë²•ë ¹í•´ì„ë¡€ì¼ë ¨ë²ˆí˜¸).\n`;

  return output;
}

// Legal interpretation text retrieval tool - Get full text of a specific interpretation
export const getInterpretationTextSchema = z.object({
  id: z.string().describe("Legal interpretation serial number (ë²•ë ¹í•´ì„ë¡€ì¼ë ¨ë²ˆí˜¸) from search results"),
  caseName: z.string().optional().describe("Case name (optional, for verification)"),
});

export type GetInterpretationTextInput = z.infer<typeof getInterpretationTextSchema>;

export async function getInterpretationText(args: GetInterpretationTextInput): Promise<string> {
  const apiKey = process.env.LAW_OC;
  if (!apiKey) {
    throw new Error("LAW_OC environment variable not set");
  }

  const params = new URLSearchParams({
    OC: apiKey,
    target: "expc",
    type: "JSON",
    ID: args.id,
  });

  if (args.caseName) {
    params.append("LM", args.caseName);
  }

  const url = `https://www.law.go.kr/DRF/lawService.do?${params.toString()}`;
  const response = await fetch(url);

  if (!response.ok) {
    throw new Error(`API error: ${response.status}`);
  }

  const responseText = await response.text();

  let data: any;
  try {
    data = JSON.parse(responseText);
  } catch (err) {
    throw new Error("Failed to parse JSON response from API");
  }

  if (!data.LawService || !data.LawService[0]) {
    throw new Error("Legal interpretation not found or invalid response format");
  }

  const expc = data.LawService[0];
  const basic = expc.ê¸°ë³¸ì •ë³´ || {};
  const content = expc.ë²•ë ¹í•´ì„ë¡€ë‚´ìš© || {};

  let output = `=== ${basic.ì•ˆê±´ëª… || "Legal Interpretation"} ===\n\n`;

  output += `ğŸ“‹ Basic Information:\n`;
  output += `  Interpretation Number: ${basic.ë²•ë ¹í•´ì„ë¡€ë²ˆí˜¸ || "N/A"}\n`;
  output += `  Response Date: ${basic.íšŒì‹ ì¼ì || "N/A"}\n`;
  output += `  Interpreting Agency: ${basic.í•´ì„ê¸°ê´€ëª… || "N/A"}\n`;
  output += `  Agency Code: ${basic.í•´ì„ê¸°ê´€ì½”ë“œ || "N/A"}\n`;
  output += `  Inquiring Agency: ${basic.ì§ˆì˜ê¸°ê´€ëª… || "N/A"}\n`;
  output += `  Managing Agency: ${basic.ê´€ë¦¬ê¸°ê´€ëª… || "N/A"}\n\n`;

  if (content.ì§ˆì˜ìš”ì§€) {
    output += `â“ Inquiry Summary (ì§ˆì˜ìš”ì§€):\n${content.ì§ˆì˜ìš”ì§€}\n\n`;
  }

  if (content.íšŒì‹ ë‚´ìš©) {
    output += `ğŸ’¬ Response (íšŒì‹ ë‚´ìš©):\n${content.íšŒì‹ ë‚´ìš©}\n\n`;
  }

  if (content.ì´ìœ ) {
    output += `ğŸ“– Reasoning (ì´ìœ ):\n${content.ì´ìœ }\n`;
  }

  return output;
}

// Simple XML parser helper
function parseXML(xml: string): any {
  const obj: any = {};

  // Extract LawSearch
  const lawSearchMatch = xml.match(/<LawSearch[^>]*>([\s\S]*?)<\/LawSearch>/);
  if (!lawSearchMatch) return obj;

  const content = lawSearchMatch[1];
  obj.LawSearch = {};

  // Extract totalCnt and page
  const totalCntMatch = content.match(/<totalCnt>([^<]*)<\/totalCnt>/);
  const pageMatch = content.match(/<page>([^<]*)<\/page>/);

  obj.LawSearch.totalCnt = totalCntMatch ? totalCntMatch[1] : "0";
  obj.LawSearch.page = pageMatch ? pageMatch[1] : "1";

  // Extract expc items
  const expcMatches = content.matchAll(/<expc>([\s\S]*?)<\/expc>/g);
  obj.LawSearch.expc = [];

  for (const match of expcMatches) {
    const expcContent = match[1];
    const expc: any = {};

    const extractTag = (tag: string) => {
      const regex = new RegExp(`<${tag}>([^<]*)<\/${tag}>`);
      const match = expcContent.match(regex);
      return match ? match[1] : "";
    };

    expc.ë²•ë ¹í•´ì„ë¡€ì¼ë ¨ë²ˆí˜¸ = extractTag("ë²•ë ¹í•´ì„ë¡€ì¼ë ¨ë²ˆí˜¸");
    expc.ì•ˆê±´ëª… = extractTag("ì•ˆê±´ëª…");
    expc.ë²•ë ¹í•´ì„ë¡€ë²ˆí˜¸ = extractTag("ë²•ë ¹í•´ì„ë¡€ë²ˆí˜¸");
    expc.íšŒì‹ ì¼ì = extractTag("íšŒì‹ ì¼ì");
    expc.í•´ì„ê¸°ê´€ëª… = extractTag("í•´ì„ê¸°ê´€ëª…");
    expc.ë²•ë ¹í•´ì„ë¡€ìƒì„¸ë§í¬ = extractTag("ë²•ë ¹í•´ì„ë¡€ìƒì„¸ë§í¬");

    obj.LawSearch.expc.push(expc);
  }

  return obj;
}
